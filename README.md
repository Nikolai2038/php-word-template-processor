# php-word-template-processor

## 1. Описание

PHP-шаблонизатор для документов Microsoft Word.

Решение вдохновлено Python-пакетом [python-docx-template](https://github.com/elapouya/python-docx-template), который, в свою очередь, имел зависимость на шаблонизатор `jinja2`, которым и был вдохновлён сам Twig. Структура документа Word является XML, и это позволяет применить шаблонизатор Twig на эту разметку, предварительно её подготовив. Это и привело к созданию данного решения.

## 2. Установка

1. В проекте необходимо установить Composer-пакеты `phpoffice/phpword` и `symfony/twig-bundle`;
2. Затем скопировать файл `./PhpWordTwigTemplateProcessor.php` себе в исходные файлы проекта в удобное место и изменить в нём `namespace` под себя;
3. Теперь в нужном классе достаточно импортировать класс `PhpWordTwigTemplateProcessor` и использовать его (пример приведён ниже).

## 3. Использование

Пример:

```php
$file_name_template = 'templates/some.docx';
$file_name_result = 'public/some.docx';

// Открытие шаблона
$templateProcessor = new PhpWordTwigTemplateProcessor($file_name_template);

// Заполнение данными
$templateProcessor->fillWithData($data);

// Сохранение в файл
$templateProcessor->saveAs($file_name_result);
```

## 4. Правила шаблона

Правила написанного шаблонизатора можно описать следующим образом:

- В документе Word можно использовать синтаксис Twig:
    - Переменные `{{ ... }}`;
    - Блоки `{% ... %}`;
    - Комментарии `{# ... #}`.

  Внутри блоков можно использовать любой синтаксис, который поддерживает сам Twig.

- Так как удобно расположение блоков в отдельных абзацах, но сами абзацы с блоками выводить не хочется, можно использовать специальных синтаксис игнорирования места расположения блока. Для его использования, необходимо написать название XML-тега разметки Word сразу после открытия блока. Например, для игнорирования абзаца (XML-тег Word `<w:p>`), нужно вместо `{% ... %}` использовать `{%p ... %}` (допустимо также `{% p ... %}`).

  Таким способом на данный момент поддерживаются теги:

    - `p` - Абзац;
    - `tr` - Строка таблицы.

  Для добавления новых тегов достаточно их добавить в массив `$TAGS_TO_MOVE_OUT`.

- Внутри синтаксиса Twig можно использовать кавычки `‘'` и `“”`, которые будут интерпретироваться как `''` и `""` соответственно. Это сделано для удобства ввода шаблона в Word, так как по умолчанию там вставляются как раз первый тип кавычек.

- Помимо функционала Twig, добавлена возможность вставки изображений по их URI. Для этого используется блок:

  ```twig
  {% picture <uri> %}
  ...
  <изображение, которое будет заменено>
  ...
  {% endpicture %}
  ```

  Если получить изображение по URI не удалось, то блок не будет выведен.

- Также присутствует возможность вертикального объединения ячеек, расположенных в одном цикле `for`.

  Это используется в двойных циклах, расположенных в таблицах, когда в первом столбце отображается идентификатор внешнего цикла.

  Для использования объединения, достаточно добавить тег `{% vm %}` (от слов "vertical merge") в нужную ячейку.

## 5. Развитие

Не стесняйтесь участвовать в развитии репозитория, используя [pull requests](https://github.com/Nikolai2038/php-word-template-processor/pulls) или [issues](https://github.com/Nikolai2038/php-word-template-processor/issues)!
